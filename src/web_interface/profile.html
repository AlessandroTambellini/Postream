<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Take a look at the posts you made">

    <title>Postream / Profile</title>

    <link rel="icon" type="image/webp" href="../assets/logo.webp">
    <link rel='stylesheet' href='./_universal.css'>

    <style>
        /* It's necessary to keep the selector 'main' 
        because '.profile-picture' is present also inside the side-panel */
        main .profile-picture {
            margin-block: 2.4rem;
            width: 225px;
        }

        @media (min-width: 500px) {
            main .profile-picture {
                width: 300px;
            }
        }

        h2 {
            text-align: center;
            padding-block: .5em;
            margin-block: 1vh;
            font-size: 2rem;
        }

        .post-card {
            margin-bottom: .5em;
        }

        .filter-nav {
            display: flex;
            justify-content: center;
            max-width: var(--card-max-width);
        }

        #search-post-form {
            flex-grow: 2;
        }

        #search-post-form button {
            margin-left: auto;
        }

        .feedback-card {
            margin-inline: auto;
            box-shadow: 0px 4px 11px 2px var(--clr-b8);
        }

        #delete-post-dialog {
            padding: 1em;
            border-radius: 8px;
            border: 1px solid var(--clr-b8);
            box-shadow: 0 4px 12px rgba(var(--rgb-00), 0.1);
            background-color: var(--clr-bkg);
            color: var(--clr-txt);
            top: 50%;

            opacity: 1;
            transform: scale(1) translateY(-50%);
            transition: all .2s ease-in-out;

            @starting-style {
                opacity: 0;
                transform: scale(0);
            }
        }

        #delete-post-dialog::backdrop {
            background-color: hsl(var(--hsl-f9), .5);
            backdrop-filter: blur(4px);
        }

        #delete-post-dialog button {
            margin-inline: auto;
        }

        #delete-post-dialog form > p {
            margin: 1em .5em;
        }

        #delete-post-dialog button[type=submit] {
            color: #F8F9FA;
            background-color: #a40c0c;
        }

        #delete-post-dialog  button[type=submit]:active {
            background-color: #620000;
        }
    </style>
</head>
<body>
    <script>
        const light_mode = localStorage.getItem('light-mode');

        if (light_mode === 'moon-mode')
        {
            document.querySelector('html').classList.add('moon-mode');
        }
    </script>

    <h1 class="visually-hidden">Profile</h1>

    <main>
        {{ .profile-picture }}

        <h2>My Posts</h2>

        <div id="posts-container" class="cards-container">{{ post-cards }}</div>

        <nav class="filter-nav" style="{{ display-filter }}">
            <form id="load-page-form" action="api/user/posts" method="get">
                <input name="load-page-input" type="number" min="1" max='{{ last-page }}' value="{{ last-page }}">
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>

                <button class="secondary-btn" type="submit" aria-label="load posts page">Load Page</button>
            </form>
    
            <form id="search-post-form" action="api/user/posts" method="get">
                <input name="search-post-input" type="search" placeholder="Search Post" required>
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>
                
                <button class="secondary-btn" type="submit">Search Post</button>
            </form>
        </nav>

        <dialog id="delete-post-dialog">
            <button type="button" class="close-btn" aria-label="close dialog">âœ—</button>
            <form id="delete-post-form" action="api/user/post" method="dialog">
                <p>Are you sure you want to delete the post?</p>
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>

                <button type="submit" class="secondary-btn">Yes</button>
            </form>
        </dialog>
    </main>

    {{ #side-panel }}

    <script type="module">
        import { 
            req,
            prettify_card_date,
            Form,
        } from './_universal.js';

        const posts_container = document.querySelector('#posts-container');
        const post_cards = posts_container.querySelectorAll('.post-card');

        const load_page = new Form(document.querySelector('#load-page-form'), req_posts_page);
        const search_post = new Form(document.querySelector('#search-post-form'), req_posts_match);
        const delete_post = new Form(document.querySelector('#delete-post-form'), req_delete_post);

        const load_page_input = load_page.form.querySelector('input');
        const search_post_input = search_post.form.querySelector('input');

        const delete_post_dialog = document.querySelector('#delete-post-dialog');
        const close_dialog_btn = delete_post_dialog.querySelector('.close-btn');

        const PAGE_SIZE = post_cards.length;
        const displayed_pages = new Set();
        const last_page = Number(load_page_input.max);
        displayed_pages.add(last_page);

        post_cards.forEach(post_card => {
            prettify_card_date(post_card);
            append_delete_post_listener(post_card.querySelector('button'));
        });

        /* I'd like to close the dialog when clicking on its background,
        but I can't append a listener to '::backdrop',
        and using e.composedPath() or e.currentTarget doesn't really help,
        because ::backdrop is still part of the dialog.
        The only option would be to let the elements inside the dialog fill all the space available
        inside the dialog itself, but it's a bit of an hack and not really precise. */
        close_dialog_btn.addEventListener("click", () => {
            delete_post_feedback_card.hide();
            delete_post_dialog.close();
        });

        async function req_posts_page(_this, res)
        {
            const requested_page = Number(load_page_input.value);
            
            if (displayed_pages.has(requested_page)) {
                res.type = 'info';
                res.msg = `Page ${requested_page} already loaded.`;
                return;
            }

            const { 
                payload: posts, 
                req_error, 
            } = await req(_this.action, _this.method, { 
                // The 'page' of the search params is overturned 
                // because in the database the pages are retrieved in opposite order
                page: last_page - requested_page + 1, 
                format: 'html',
            });

            if (req_error) {
                res.type = 'error';
                res.msg = req_error.interpret('page', 'retrieve');
                return;
            }

            if (displayed_pages.size > 1) {
                posts_container.appendChild(document.createElement('hr'));
            }
            
            posts.forEach(post => {
                const post_card = document.createRange().createContextualFragment(post.card);
                prettify_card_date(post_card);
                append_delete_post_listener(post_card.querySelector('button'));
                posts_container.appendChild(post_card);
            });

            displayed_pages.add(requested_page);
        }

        async function req_posts_match(_this, res)
        {
            const { 
                payload: posts, 
                req_error, 
            } = await req(_this.action, _this.method, { 
                match: search_post_input.value,
                format: 'html',
            });

            if (req_error) {
                res.type = 'error';
                res.msg = req_error.msg;
                return;
            } 
        
            displayed_pages.clear();
            posts_container.replaceChildren();
            posts.forEach(post => 
            {
                const post_card = document.createRange().createContextualFragment(post.card);
                prettify_card_date(post_card);
                append_delete_post_listener(post_card.querySelector('button'));
                posts_container.appendChild(post_card);
            });

            if (posts.length === 0) {
                res.type = 'info';
                res.msg = 'There aren\'t posts matching the search parameters';
                return;
            }
        }

        async function req_delete_post(_this, res)
        {
            const post_id = delete_post_dialog.returnValue;
            const { req_error } = await req(_this.action, 'DELETE', { id: post_id });

            if (req_error) {
                res.type = 'error';
                res.msg = req_error.interpret('post', 'delete');
                return;
            } 

            delete_post_dialog.close();
            document.querySelector(`#post-card-${post_id}`).classList.add('deleting');
        }

        function append_delete_post_listener(btn)
        {
            btn.addEventListener('click', () =>
            {
                delete_post_dialog.showModal();
                delete_post_dialog.returnValue = btn.dataset.postId;
            });
        }
    </script>
</body>
</html>
