<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Take a look at the posts you made">

    <title>Postream / Profile</title>

    <link rel="icon" type="image/webp" href="../assets/logo.webp">
    <link rel='stylesheet' href='_universal.css'>

    <style>
        /* It's fundamental to keep the selector 'main' because '.profile-picture'
        is present also inside the side-panel */
        main .profile-picture {
            margin-block: 2.4rem;
            width: 225px;
        }

        @media (min-width: 500px) {
            main .profile-picture {
                width: 300px;
            }
        }

        h2 {
            text-align: center;
            padding-block: .5em;
            margin-block: 1vh;
            font-size: 2rem;
        }

        .post-card {
            margin-bottom: .5em;
        }

        #filter-posts-nav {
            display: flex;
            justify-content: center;
            max-width: var(--card-max-width);
        }

        #search-post-form {
            flex-grow: 2;
        }

        #search-post-form button {
            margin-left: auto;
        }

        .feedback-card {
            margin-inline: auto;
            box-shadow: 0px 4px 11px 2px var(--clr-b8);
        }

        #delete-post-dialog {
            padding: 1em;
            border-radius: 8px;
            border: 1px solid var(--clr-b8);
            box-shadow: 0 4px 12px rgba(var(--rgb-00), 0.1);
            background-color: var(--clr-f9);
            color: var(--clr-txt);
            top: 50%;

            opacity: 1;
            transform: scale(1) translateY(-50%);
            transition: all .2s ease-in-out;

            @starting-style {
                opacity: 0;
                transform: scale(0);
            }
        }

        #delete-post-dialog::backdrop {
            background-color: hsl(var(--hsl-f9), .5);
            backdrop-filter: blur(4px);
        }

        #delete-post-dialog button {
            margin-inline: auto;
        }

        #delete-post-dialog form > p {
            margin: 1em .5em;
        }

        #delete-post-dialog button[type=submit] {
            color: #F8F9FA;
            background-color: #a40c0c;
        }

        #delete-post-dialog  button[type=submit]:active {
            background-color: #620000;
        }
    </style>

    <script type="module" src="../scripts/profile.js"></script>
</head>
<body>
    <script>
        const light_mode = localStorage.getItem('light-mode');

        if (light_mode === 'moon-mode')
        {
            document.querySelector('html').classList.add('moon-mode');
        }
    </script>

    <h1 class="visually-hidden">Profile</h1>

    <main>
        {{ .profile-picture }}

        <h2>My Posts</h2>

        <div id="posts-container" class="cards-container">{{ post-cards }}</div>

        <nav id="filter-posts-nav">
            <form id="load-page-form">
                <input name="load-page-input" type="number" min="1" max='{{ last-page }}' value="{{ last-page }}">
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>

                <button class="secondary-btn" type="submit" aria-label="load posts page">Load</button>
            </form>
    
            <form id="search-post-form">
                <input name="search-post-input" type="search" placeholder="Search Post" required>
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>
                
                <button class="secondary-btn" type="submit">Search</button>
            </form>
        </nav>

        <dialog id="delete-post-dialog">
            <button type="button" class="close-btn" aria-label="close dialog">âœ—</button>
            <form method="dialog">
                <p>Are you sure you want to delete the post?</p>
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>

                <button type="submit" class="secondary-btn">Yes</button>
            </form>
        </dialog>
    </main>

    {{ #side-panel }}

    <script type="module">
import { req, hide_feedback_card, show_feedback_card, construct_err_msg } from './_universal.js';

const posts_container = document.querySelector('#posts-container');
const load_page_form = document.querySelector('#load-page-form');
const load_page_input = load_page_form.querySelector('input');
const search_post_form = document.querySelector('#search-post-form');
const search_post_input = search_post_form.querySelector('input');
const post_cards = posts_container.querySelectorAll('.post-card');

const delete_post_dialog = document.querySelector('#delete-post-dialog');
const close_dialog_btn = delete_post_dialog.querySelector('.close-btn');
const delete_post_btn = delete_post_dialog.querySelector('button[type=submit]');

const load_page_feedback_card = document.querySelector('#load-page-form .feedback-card');
const search_post_feedback_card = document.querySelector('#lsearch-post-form .feedback-card');
const delete_post_feedback_card = document.querySelector('#delete-post-dialog .feedback-card');

const DEFAULT_PAGE_SIZE = post_cards.length;
const displayed_posts = new Set();
let last_action_is_search = false;
const last_page = Number(load_page_input.max);

/* I'd like to close the dialog when clicking on its background,
but I can't append a listener to '::backdrop',
and using e.composedPath() or e.currentTarget doesn't really help,
because ::backdrop is still part of the dialog.
The only option would be to let the elements inside the dialog fill all the space available
inside the dialog itself, but it's a bit of an hack and not really precise. */
close_dialog_btn.addEventListener("click", () => {
    delete_post_dialog.close();
    hide_feedback_card(delete_post_feedback_card);
});

delete_post_btn.addEventListener('click', async e =>
{
    e.preventDefault();

    const post_id = delete_post_dialog.returnValue;
    const { req_error } = await req('api/post', 'DELETE', { id: post_id });

    if (req_error) {
        show_feedback_card(delete_post_feedback_card, 'error', construct_err_msg(req_error.code, 'post', 'delete', req_error.msg));
    } else {
        delete_post_dialog.close();
        const post_card = document.querySelector(`#post-card-${post_id}`);
        post_card.classList.add('deleting');
    }
});

post_cards.forEach(post => {
    displayed_posts.add(Number(post.dataset.postId));
});

document.querySelectorAll('.delete-post-btn').forEach(button => {
    append_delete_post_listener(button);
});

load_page_form.addEventListener('submit', async e =>
{
    e.preventDefault();
    hide_feedback_card(load_page_feedback_card);

    const page = last_page - Number(load_page_input.value) + 1;

    const { payload: posts, req_error } = await req('api/posts/user/page', 'GET', { page, format: 'html' });

    if (req_error) {
        show_feedback_card(load_page_feedback_card, 'error', construct_err_msg(req_error.code, 'page', 'retrieve', req_error.msg));
        return;
    }

    if (last_action_is_search) {
        posts_container.replaceChildren();
        displayed_posts.clear();
        last_action_is_search = false;
    }

    let new_posts_displayed = 0;
    posts.forEach(post => {
        if (!displayed_posts.has(post.id)) {
            displayed_posts.add(post.id);
            new_posts_displayed++;
            const post_card = document.createRange().createContextualFragment(post.card);
            append_delete_post_listener(post_card.querySelector('.delete-post-btn'));
            posts_container.appendChild(post_card);
        }
    });

    if (new_posts_displayed < DEFAULT_PAGE_SIZE && page < last_page) {
        const msg = `Expected to retrieve ${DEFAULT_PAGE_SIZE} posts, ` +
            `but ${new_posts_displayed} post${new_posts_displayed === 1 ? ' was' : 's were'} ` +
            'retrieved instead. Either this page was already loaded or some post was created/deleted in the meanwhile.';
        show_feedback_card(load_page_feedback_card, 'info', msg);
    } else if (new_posts_displayed === 0) {
        show_feedback_card(load_page_feedback_card, 'info', 'There aren\'t other posts to show');
    }

});

search_post_form.addEventListener('submit', async e =>
{
    e.preventDefault();
    hide_feedback_card(search_post_feedback_card);

    const { payload: posts, req_error } = await req('api/posts/user/search', 'GET', { 
        search_term: search_post_input.value,
        format: 'html',
    });

    if (req_error) {
        show_feedback_card(search_post_feedback_card, 'error', req_error.msg);
    } else {
        last_action_is_search = true;
        posts_container.replaceChildren();
        posts.forEach(post => {
            const post_card = document.createRange().createContextualFragment(post.card);
            append_delete_post_listener(post_card.querySelector('.delete-post-btn'));
            posts_container.appendChild(post_card);
        });

        if (posts.length === 0) {
            show_feedback_card(search_post_feedback_card, 'info', 'There aren\'t posts matching the search parameters');
        }
    }
});

function append_delete_post_listener(btn)
{
    btn.addEventListener('click', () =>
    {
        delete_post_dialog.showModal();
        delete_post_dialog.returnValue = btn.dataset.postId;
    });
}
    </script>
</body>
</html>
