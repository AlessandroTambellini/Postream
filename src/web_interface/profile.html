<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Take a look at the posts you made">

    <title>Postream / Profile</title>

    <link rel="icon" type="image/webp" href="../assets/logo.webp">
    <link rel='stylesheet' href='./_universal.css'>

    <style>
        /* It's fundamental to keep the selector 'main' because '.profile-picture'
        is present also inside the side-panel */
        main .profile-picture {
            margin-block: 2.4rem;
            width: 225px;
        }

        @media (min-width: 500px) {
            main .profile-picture {
                width: 300px;
            }
        }

        h2 {
            text-align: center;
            padding-block: .5em;
            margin-block: 1vh;
            font-size: 2rem;
        }

        .post-card {
            margin-bottom: .5em;
        }

        #filter-posts-nav {
            display: flex;
            justify-content: center;
            max-width: var(--card-max-width);
        }

        #search-post-form {
            flex-grow: 2;
        }

        #search-post-form button {
            margin-left: auto;
        }

        .feedback-card {
            margin-inline: auto;
            box-shadow: 0px 4px 11px 2px var(--clr-b8);
        }

        #delete-post-dialog {
            padding: 1em;
            border-radius: 8px;
            border: 1px solid var(--clr-b8);
            box-shadow: 0 4px 12px rgba(var(--rgb-00), 0.1);
            background-color: var(--clr-f9);
            color: var(--clr-txt);
            top: 50%;

            opacity: 1;
            transform: scale(1) translateY(-50%);
            transition: all .2s ease-in-out;

            @starting-style {
                opacity: 0;
                transform: scale(0);
            }
        }

        #delete-post-dialog::backdrop {
            background-color: hsl(var(--hsl-f9), .5);
            backdrop-filter: blur(4px);
        }

        #delete-post-dialog button {
            margin-inline: auto;
        }

        #delete-post-dialog form > p {
            margin: 1em .5em;
        }

        #delete-post-dialog button[type=submit] {
            color: #F8F9FA;
            background-color: #a40c0c;
        }

        #delete-post-dialog  button[type=submit]:active {
            background-color: #620000;
        }
    </style>
</head>
<body>
    <script>
        const light_mode = localStorage.getItem('light-mode');

        if (light_mode === 'moon-mode')
        {
            document.querySelector('html').classList.add('moon-mode');
        }
    </script>

    <h1 class="visually-hidden">Profile</h1>

    <main>
        {{ .profile-picture }}

        <h2>My Posts</h2>

        <div id="posts-container" class="cards-container">{{ post-cards }}</div>

        <nav id="filter-posts-nav">
            <form id="load-page-form">
                <input name="load-page-input" type="number" min="1" max='{{ last-page }}' value="{{ last-page }}">
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>

                <button class="secondary-btn" type="submit" aria-label="load posts page">Load</button>
            </form>
    
            <form id="search-post-form">
                <input name="search-post-input" type="search" placeholder="Search Post" required>
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>
                
                <button class="secondary-btn" type="submit">Search</button>
            </form>
        </nav>

        <dialog id="delete-post-dialog">
            <button type="button" class="close-btn" aria-label="close dialog">âœ—</button>
            <form method="dialog">
                <p>Are you sure you want to delete the post?</p>
                <div class="card feedback-card display-none">
                    <span role='img' alt='feedback icon'></span>
                    <p>
                        <span class='type'></span>
                        <span class='msg'></span>
                    </p>
                    <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
                </div>

                <button type="submit" class="secondary-btn">Yes</button>
            </form>
        </dialog>
    </main>

    {{ #side-panel }}

    <script type="module">
        import { 
            req,
            prettify_date,
            FeedbackCard,
        } from './_universal.js';

        const posts_container = document.querySelector('#posts-container');
        const post_cards = posts_container.querySelectorAll('.post-card');

        const load_page_form = document.querySelector('#load-page-form');
        const load_page_input = load_page_form.querySelector('input');
        const search_post_form = document.querySelector('#search-post-form');
        const search_post_input = search_post_form.querySelector('input');

        const delete_post_dialog = document.querySelector('#delete-post-dialog');
        const close_dialog_btn = delete_post_dialog.querySelector('.close-btn');
        const delete_post_btn = delete_post_dialog.querySelector('button[type=submit]');

        const load_page_feedback_card = new FeedbackCard(load_page_form.querySelector('.feedback-card'));
        const search_post_feedback_card = new FeedbackCard(search_post_form.querySelector('.feedback-card'));
        const delete_post_feedback_card = new FeedbackCard(delete_post_dialog.querySelector('.feedback-card'));

        const PAGE_SIZE = post_cards.length;
        const displayed_pages = new Set();
        const last_page = Number(load_page_input.max);
        displayed_pages.add(last_page);
        let last_action_is_search = false;

        post_cards.forEach(post_card => {
            const time = post_card.querySelector('time');
            time.textContent = prettify_date(time.dateTime);
            append_delete_post_listener(post_card.querySelector('.delete-post-btn'));
        });

        /* I'd like to close the dialog when clicking on its background,
        but I can't append a listener to '::backdrop',
        and using e.composedPath() or e.currentTarget doesn't really help,
        because ::backdrop is still part of the dialog.
        The only option would be to let the elements inside the dialog fill all the space available
        inside the dialog itself, but it's a bit of an hack and not really precise. */
        close_dialog_btn.addEventListener("click", () => {
            delete_post_feedback_card.hide();
            delete_post_dialog.close();
        });

        delete_post_btn.addEventListener('click', async e =>
        {
            delete_post_feedback_card.hide();

            const post_id = delete_post_dialog.returnValue;
            const { req_error } = await req('api/post', 'DELETE', { id: post_id });

            if (req_error) {
                delete_post_feedback_card.show('error', req_error.interpret('post', 'delete'));
            } else {
                delete_post_dialog.close();
                const post_card = document.querySelector(`#post-card-${post_id}`);
                post_card.classList.add('deleting');
            }
        });

        load_page_form.addEventListener('submit', async e =>
        {
            e.preventDefault();
            load_page_feedback_card.hide();

            const requested_page = Number(load_page_input.value);
            if (displayed_pages.has(requested_page)) {
                load_page_feedback_card.show('info', `Page ${requested_page} already loaded.`);
                return;
            }

            const { 
                payload: posts, 
                req_error, 
            } = await req('api/posts/user/page', 'GET', { 
                // The 'page' of the search params is overturned 
                // because on the server the pages are in opposite order
                page: last_page - requested_page + 1, 
                format: 'html',
            });

            if (req_error) {
                load_page_feedback_card.show('error', req_error.interpret('page', 'retrieve'));
                return;
            }

            if (last_action_is_search) {
                posts_container.replaceChildren();
                displayed_pages.clear();
                last_action_is_search = false;
            }

            posts_container.appendChild(document.createElement('hr'));
            posts.forEach(post => {
                const post_card = document.createRange().createContextualFragment(post.card);
                const time = post_card.querySelector('time');
                time.textContent = prettify_date(time.dateTime);
                append_delete_post_listener(post_card.querySelector('.delete-post-btn'));
                posts_container.appendChild(post_card);
            });

            displayed_pages.add(requested_page);
        });

        search_post_form.addEventListener('submit', async e =>
        {
            e.preventDefault();
            search_post_feedback_card.hide();

            const { payload: posts, req_error } = await req('api/posts/user/search', 'GET', { 
                search_term: search_post_input.value,
                format: 'html',
            });

            if (req_error) {
                search_post_feedback_card.show('error', req_error.msg);
            } else {
                last_action_is_search = true;
                posts_container.replaceChildren();
                posts.forEach(post => {
                    const post_card = document.createRange().createContextualFragment(post.card);
                    const time = post_card.querySelector('time');
                    time.textContent = prettify_date(time.dateTime);
                    append_delete_post_listener(post_card.querySelector('.delete-post-btn'));
                    posts_container.appendChild(post_card);
                });

                if (posts.length === 0) {
                    search_post_feedback_card.show('info', 'There aren\'t posts matching the search parameters');
                }
            }
        });

        function append_delete_post_listener(btn)
        {
            btn.addEventListener('click', () =>
            {
                delete_post_dialog.showModal();
                delete_post_dialog.returnValue = btn.dataset.postId;
            });
        }
    </script>
</body>
</html>
