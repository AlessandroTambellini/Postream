<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Login">

    <title>Postream / Login</title>

    <link rel="icon" type="image/webp" href="../assets/logo.webp">
    <link rel='stylesheet' href='../stylesheets/_universal.css'>

    <style>
        label[for=password] {
            padding-bottom: .25em;
            display: inline-block;
        }

        button[type=submit] {
            margin-left: auto;
        }
    </style>
</head>
<body>
    <script>
        const light_mode = localStorage.getItem('light-mode');
        if (light_mode === 'moon-mode')
        {
            document.querySelector('html').classList.add('moon-mode');
        }
    </script>

    <h1 class="visually-hidden">Login</h1>

    <main>
        <form action="/api/token">

            <!-- Not used. Here only to shut-up a browser warning
             about best practices for forms. -->
            <input type="text" id="username" hidden autocomplete="username">

            <label for="password">Password:</label>
            <input
                id="password"
                name="password"
                type="password"
                autocomplete="current-password" placeholder="路路路路路路路路路路路路路路路路路路路路">

            <div class="card feedback-card display-none">
                <span role='img' alt='feedback icon'></span>
                <p>
                    <span class='type'></span>
                    <span class='msg'></span>
                </p>
                <button class="close-btn" type='button' aria-label='close feedback'></button>
            </div>

            <button class="primary-btn" type="submit">
                Login
            </button>
        </form>
    </main>

    {{ #side-panel }}

    <script type="module">
        import { req, construct_err_msg, hide_feedback_card, show_feedback_card } from "../scripts/_universal.js";

        const login_form = document.querySelector('form');
        const feedback_card = login_form.querySelector('.feedback-card');
        const password_input = login_form.querySelector('input[name=password]');

        login_form.addEventListener('submit', async e =>
        {
            e.preventDefault();
            hide_feedback_card(feedback_card);

            const path = login_form.attributes.action.value;
            const password = password_input.value;

            /*
            - If it's the first time that the user logs in, it's a POST.
            - If it isn't the first time that the user logs in, it's a PUT. But,
                - if previously the user logged out, I don't have anymore the password_hash on the client. Therefore,
                I first need to retrieve it (GET).
            */

            // 1) Let's try to directly make a POST. Perhaps is the first login ever.
            const req_POST = await req(path, 'POST', null, { password });

            if (!req_POST.req_error) {
                document.cookie = `password_hash=${req_POST.payload.password_hash}`;
                location.href = '/';
                return;
            }

            // 2) Otherwise, try to get the password_hash and then update the token
            const req_GET = await req(path, 'GET', { password });

            if (req_GET.req_error) {
                show_feedback_card(feedback_card, 'error', construct_err_msg(req_GET.status_code, 'password', req_GET.req_error));
                return;
            }

            const req_PUT = await req(path, 'PUT', null, { password });

            if (req_PUT.req_error) {
                show_feedback_card(feedback_card, 'error', construct_err_msg(req_PUT.status_code, 'password', req_GET.req_error));
                return;
            }

            document.cookie = `password_hash=${req_PUT.payload.password_hash}`;
            location.href = '/';
        });
    </script>
</body>
</html>
