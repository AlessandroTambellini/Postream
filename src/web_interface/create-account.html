<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Create an account">

    <title>Postream / Create Account</title>

    <link rel="icon" type="image/webp" href="../assets/logo.webp">
    <link rel='stylesheet' href='./_universal.css'>
            
    <style>
        :root {
            --password-bkg: #fff9f9;
        }
        
        :root.moon-mode {
            --password-bkg: #000606;
        }

        form {
            padding-block: 1em;
        }

        div:has(#password) {
            position: relative;
            background-color: var(--password-bkg);
            border: 2px solid rosybrown;
            border-radius: 8px;
            width: fit-content;
            margin-inline: auto;
            margin-block: 1rem;
        }

        div:has(#password) button {
            font-family: sans-serif;
            display: block;
            letter-spacing: 1px;
            padding: .4em 1em;
            margin-left: auto;
            border-top-right-radius: 8px;
            font-size: .9rem;
            border: none;
            transition: background-color .25s ease;
        }

        div:has(#password) button.btn-unclicked {
            background-color: transparent;
        }

        div:has(#password) button.btn-unclicked:hover {
            background-color: var(--clr-cc);
        }

        div:has(#password) button.btn-clicked {
            color: darkgreen;
            background-color: rgb(219, 255, 199);
        }

        #password {
            font-size: 1.2rem;
            font-weight: 500;
            padding: .25em 1.25em .75em 1.25em;
        }

        button[type=submit] {
            margin: auto;
        }

        main > a[href=login] {
            display: block;
            margin: auto;
            margin-top: 1em;
            width: fit-content;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <script>
        const light_mode = localStorage.getItem('light-mode');

        if (light_mode === 'moon-mode')
        {
            document.querySelector('html').classList.add('moon-mode');
        }
    </script>
    
    <main>
        <h1 class="visually-hidden">Create Account</h1>

        <p class="info-msg">
            The password is generated automatically and you don't have any username.
            Once you click on 'Create Account', you'll receive the password. 
            That's the password you'll have to use to then login.
        </p>

        <form id="create-account-form" action="api/user" method="POST">
            <div class="card feedback-card display-none">
                <span role='img' alt='feedback icon'></span>
                <p>
                    <span class='type'></span>
                    <span class='msg'></span>
                </p>
                <button class="close-btn" type='button' aria-label='close feedback'>ðŸ—™</button>
            </div>

            <button class="primary-btn" type="submit">
                Create Account
            </button>
        </form>

        <div class="display-none">
            <button class="btn-unclicked">Copy</button>
            <p id="password"></p>
        </div>

        <a href="login">Login</a>
    </main>

    {{ #side-panel }}

    <script type="module">
        
        import { 
            req, 
            Form,
        } from './_universal.js';

        // It's possible to create an account while logged-in.

        const password_container = document.querySelector('div:has(#password)');
        const password_p = document.querySelector('#password');
        const copy_password_btn = password_container.querySelector('button');
        
        new Form(document.querySelector('#create-account-form'), async (_this, res) => 
        {
            const { 
                payload, 
                req_error, 
            } = await req(_this.action, _this.method);
            
            if (req_error) {
                res.type = 'error';
                res.msg = req_error.interpret();
            } else {
                password_p.textContent = payload.password;
                // Once a registration happens, 
                // the previous cookie is deleted to avoid conflicts with a previous user in case of login
                document.cookie = 'password_hash=';
                password_container.classList.replace('display-none', 'display-block');
            }
        });

        let timeout_id = -1;
        copy_password_btn.addEventListener('click', () => 
        {
            clearTimeout(timeout_id);
            navigator.clipboard.writeText(password_p.textContent);

            copy_password_btn.textContent = 'Copied';
            copy_password_btn.classList.replace('btn-unclicked', 'btn-clicked');
            
            timeout_id = setTimeout(() => {
                copy_password_btn.classList.replace('btn-clicked', 'btn-unclicked');
                copy_password_btn.textContent = 'Copy';
            }, 3000);
        });     
    </script>
</body>
</html>
